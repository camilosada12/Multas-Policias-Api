

services:
  sqlserverBack:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserverBack
    ports: ["1433:1433"]
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Admin123.
    volumes:
      - sql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U SA -P $$SA_PASSWORD -Q \"SELECT 1\" || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  postgresBack:
    image: postgres:16-alpine
    container_name: postgresBack
    environment:
      - POSTGRES_DB=controlComparendoDB
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=Admin123.
    ports: ["5433:5432"]
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ControlComparendo"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  mysqlBack:
    image: mysql:8.3
    container_name: mysqlBack
    environment:
      - MYSQL_ROOT_PASSWORD=Admin123.
      - MYSQL_DATABASE=controlComparendoDB
    ports: ["3307:3306"]
    volumes:
      - mysql_data:/var/lib/mysql
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password"]
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 15s

  backend:
    build:
      context: ./taller 
      dockerfile: Web/Dockerfile
    container_name: backend
    ports: ["8080:8080"]
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__SqlServer=Server=sqlserverBack,1433;Database=controlComparendoDB;User Id=sa;Password=Admin123.;Encrypt=False;TrustServerCertificate=True
      - ConnectionStrings__Postgres=Host=postgresBack;Port=5432;Database=controlComparendoDB;Username=postgres;Password=Admin123.
      - ConnectionStrings__MySql=Server=mysqlBack;Port=3306;Database=controlComparendoDB;User ID=root;Password=Admin123.;SslMode=Preferred;AllowPublicKeyRetrieval=True;CharSet=utf8mb4;DefaultCommandTimeout=60;Connection Timeout=60;Pooling=true;MinimumPoolSize=0;MaximumPoolSize=50;
      - MIGRATE_SQLSERVER=true
      - MIGRATE_POSTGRES=true
      - MIGRATE_MYSQL=true
    depends_on:
      sqlserverBack:
        condition: service_healthy
      postgresBack:
        condition: service_healthy
      mysqlBack:
        condition: service_healthy

volumes:
  sql_data:
  postgres_data:
  mysql_data:
